<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot by Bang Thien Nguye Login</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">

    <!-- Message Box (replaces alert()) -->
    <div id="message-container" class="fixed top-4 right-4 z-50"></div>

    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl space-y-6">
        <h2 class="text-3xl font-bold text-center text-gray-800">Login to Code Assistant</h2>
        
        <form id="login-form" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <!-- Default values set for quick testing: admin -->
                <input type="text" id="username" value="admin" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                       placeholder="Enter username">
            </div>
            
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <!-- Default values set for quick testing: admin1234@ -->
                <input type="password" id="password" value="admin1234@" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                       placeholder="Enter password">
            </div>
            
            <button type="submit" id="loginBtn"
                    class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-150 ease-in-out">
                Sign In
            </button>
        </form>
    </div>

    <script>
        // Custom message box to replace alert()
        function showMessage(msg, isError = true) {
            const container = document.getElementById('message-container');
            const color = isError ? 'bg-red-500' : 'bg-green-500';
            const messageBox = document.createElement('div');
            
            messageBox.className = `p-3 mb-2 text-sm text-white ${color} rounded-lg shadow-lg opacity-0 transition-opacity duration-300`;
            messageBox.textContent = msg;
            
            container.appendChild(messageBox);
            
            // Fade in
            setTimeout(() => messageBox.classList.remove('opacity-0'), 10);
            
            // Fade out and remove
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => container.removeChild(messageBox), 300);
            }, 3000);
        }

        async function doLogin(event) {
            event.preventDefault(); // Prevent default form submission
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // CRITICAL FIX: Use the dedicated /api/login endpoint and absolute URL
            const apiUrl = window.location.origin + '/api/login';
            
            let res;
            try {
                res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
            } catch (e) {
                showMessage('Network error. Check server connection.', true);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
                return;
            }

            // Read body only once as text
            let responseBodyText = '';
            try {
                responseBodyText = await res.text();
            } catch (e) {
                showMessage('Login failed: Could not read server response.', true);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
                return;
            }

            if (res.ok) {
                // Successful response (200 OK)
                try {
                    const data = JSON.parse(responseBodyText);
                    localStorage.setItem('jwt', data.token); 
                    showMessage('Login successful!', false);
                    // Use absolute path for navigation
                    window.location.href = window.location.origin + '/chat';
                } catch (e) {
                    showMessage('Login succeeded, but server response was unreadable.', true);
                }
            } else {
                // Error response (401, 404, 500, etc.)
                try {
                    // Attempt to parse standard JSON error body (e.g., Flask's 401 response)
                    const data = JSON.parse(responseBodyText);
                    showMessage(data.msg || 'Invalid username or password.');
                } catch (e) {
                    // Fallback if the server returned non-JSON content (e.g., HTML error page like a 404)
                    showMessage(`Login failed (Status ${res.status}). Ensure the /api/login route is active and running on your Flask server.`);
                }
            }

            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
        }

        document.getElementById('login-form').addEventListener('submit', doLogin);
    </script>
</body>
</html>
